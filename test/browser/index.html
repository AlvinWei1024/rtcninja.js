<!DOCTYPE html>
<html>

<head>
	<title>rtcninja.js</title>
	<meta http-equiv='Content-Type' content='text/html; charset=utf-8' />
	<link rel='stylesheet' type='text/css' href='style.css' media='screen' />
	<script src='Temasys-adapter.js'></script>
	<script src='rtcninja.js'></script>
	<script src='Peer.js'></script>
	<script>
		// rtcninja.debug.enable('rtcninja*');
		rtcninja.debug.enable('*');
	</script>

	<script>
	function test() {
		var debug = rtcninja.debug('index.html');
		var peerA, peerB;
		var localStream = null;
		var peerAlocalVideo = document.querySelector('#peerA video.local');
		var peerAremoteVideo = document.querySelector('#peerA video.remote');
		var peerBlocalVideo = document.querySelector('#peerB video.local');
		var peerBremoteVideo = document.querySelector('#peerB video.remote');

		rtcninja.getUserMedia(
			{audio:true, video:true},
			function(stream) {
				localStream = stream;
				startTheParty();
			},
			function(error) {
				console.error('index.html getUserMedia() failed:', error);
			}
		);

		window.closeParty = function() {
			if (peerA) { peerA.connection.close(); }
			if (peerB) { peerB.connection.close(); }
			if (localStream) { rtcninja.Utils.closeMediaStream(localStream); }
		}

		function startTheParty() {
			debug('startTheParty()');

			var pcConfig = {
				iceServers: [{
					// urls: [
					// 	'turn:turn.ef2f.com:3478?transport=udp',
					// 	'turn:turn.ef2f.com:3478?transport=tcp',
					// 	'turns:turn.ef2f.com:443?transport=tcp'
					// ],
					urls: 'turn:turn.ef2f.com:3478?transport=udp',
					username: 'turn',
					credential: 'ef2f'
				}],
				iceTransports: 'relay',
				gatheringTimeoutAfterRelay: 2000
			};

			peerA = new Peer('A', localStream, pcConfig);
			peerB = new Peer('B', localStream, pcConfig);

			// TMP: expose global variables.
			window.peerA = peerA;

			rtcninja.Utils.attachMediaStream(peerAlocalVideo, localStream);
			rtcninja.Utils.attachMediaStream(peerBlocalVideo, localStream);

			peerA.connection.onicecandidate = function(event, candidate) {
				if (! candidate) { return; }
				peerB.connection.addIceCandidate(candidate);
			};

			peerB.connection.onicecandidate = function(event, candidate) {
				if (! candidate) { return; }
				peerA.connection.addIceCandidate(candidate);
			};

			peerA.connection.onaddstream = function(event, stream) {
				rtcninja.Utils.attachMediaStream(peerAremoteVideo, stream);
			};

			peerB.connection.onaddstream = function(event, stream) {
				rtcninja.Utils.attachMediaStream(peerBremoteVideo, stream);
			};

			peerA.call(function(offer) {
				peerB.answer(offer, function(answer) {
					peerA.connection.setRemoteDescription(answer);
				});
			});
		}
	}
	</script>
</head>

<body onload='test()'>

	<div class='header'></div>

	<div class='videos'>
		<div id='peerA' class='peerVideo'>
			<p class='remote'>peer B</p>
			<p class='local'>peer A</p>
			<video class='remote' autoplay></video>
			<video class='local' autoplay muted='true'></video>
		</div>

		<div class='space'></div>

		<div id='peerB' class='peerVideo'>
			<p class='remote'>peer A</p>
			<p class='local'>peer B</p>
			<video class='remote' autoplay></video>
			<video class='local' autoplay muted='true'></video>
		</div>
	</div>
</body>

</html>
