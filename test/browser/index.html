<!DOCTYPE html>
<html>

<head>
	<title>rtcninja.js</title>
	<meta http-equiv='Content-Type' content='text/html; charset=utf-8' />
	<link rel='stylesheet' type='text/css' href='style.css' media='screen' />
	<!-- <script src='Temasys-adapter.js'></script> -->
	<script src='rtcninja.js'></script>
	<script src='Peer.js'></script>
	<script>
		// rtcninja.debug.enable('rtcninja*');
		rtcninja.debug.enable('*');
	</script>

	<script>
	document.addEventListener('DOMContentLoaded', function() {
		startTheParty();
	}, false);

	function startTheParty() {
		var debug = rtcninja.debug('index.html');
		var debugerror = rtcninja.debug('index.html:ERROR');
		var peerA, peerB;
		var localStream = null;
		var status = 'stopped';  // 'stopped', 'connecting', 'connected'.
		var startStopButton = document.querySelector('#startStopButton');
		var peerAlocalVideo = document.querySelector('#peerA video.local');
		var peerAremoteVideo = document.querySelector('#peerA video.remote');
		var peerBlocalVideo = document.querySelector('#peerB video.local');
		var peerBremoteVideo = document.querySelector('#peerB video.remote');

		startStopButton.addEventListener('click', onStartStopButtonClick, false);

		function onStartStopButtonClick() {
			if (status === 'stopped') {
				start();
			}
			else if (status === 'connected') {
				stop();
			}
		}

		function onConnecting(text) {
			debug('onConnecting()');

			status = 'connecting';
			startStopButton.textContent = text || 'connecting ...';
			startStopButton.classList.add('connecting');
		}

		function onConnected() {
			debug('onConnected()');

			status = 'connected';
			startStopButton.textContent = 'stop';
			startStopButton.classList.remove('connecting');
			startStopButton.classList.add('connected');
		}

		function onStopped() {
			debug('onStopped()');

			status = 'stopped';
			startStopButton.textContent = 'start';
			startStopButton.classList.remove('connecting');
			startStopButton.classList.remove('connected');
			startStopButton.classList.remove('established');
		}

		function onEstablished() {
			debug('onEstablished');

			startStopButton.classList.add('established');
		}

		function getLocalStream(callback, errback) {
			debug('getLocalStream()');

			rtcninja.getUserMedia(
				{audio:true, video:true},
				function(stream) {
					callback(stream);
				},
				errback
			);
		}

		function start() {
			debug('start()');

			if (! localStream) {
				onConnecting('requesting media ...');

				getLocalStream(
					// success
					function(stream) {
						localStream = stream;
						start();
					},
					// failure
					function(error) {
						debugerror('getUserMedia() failed:', error);
						onStopped();
						throw error;
					}
				);

				return;
			}

			onConnecting();

			var pcConfig = {
				// iceServers: [],
				// iceServers: [
				// 	{ url:'turn:turn.ef2f.com:3478?transport=udp', username:'turn', credential:'ef2f' },
				// 	{ url:'turn:turn.ef2f.com:3478?transport=tcp', username:'turn', credential:'ef2f' },
				// 	{ url:'turns:turn.ef2f.com:443?transport=tcp', username:'turn', credential:'ef2f' }
				// ],
				iceServers: [
					{
						urls: [
							'turn:turn.ef2f.com:3478?transport=udp',
							'turn:turn.ef2f.com:3478?transport=tcp',
							'turns:turn.ef2f.com:443?transport=tcp'
						],
						username:'turn',
						credential:'ef2f'
					}
				],
				// iceTransports: 'relay',
				gatheringTimeoutAfterRelay: 500
			};

			peerA = new Peer('A', localStream, pcConfig);
			peerB = new Peer('B', localStream, pcConfig);

			// TMP: expose global variables.
			window.peerA = peerA;
			window.peerB = peerB;

			peerAlocalVideo = rtcninja.attachMediaStream(peerAlocalVideo, localStream);
			peerBlocalVideo = rtcninja.attachMediaStream(peerBlocalVideo, localStream);

			peerA.connection.onicecandidate = function(event, candidate) {
				if (! candidate) { return; }
				peerB.connection.addIceCandidate(candidate);
			};

			peerB.connection.onicecandidate = function(event, candidate) {
				if (! candidate) { return; }
				peerA.connection.addIceCandidate(candidate);
			};

			peerA.connection.onaddstream = function(event, stream) {
				peerAremoteVideo = rtcninja.attachMediaStream(peerAremoteVideo, stream);
			};

			peerB.connection.onaddstream = function(event, stream) {
				peerBremoteVideo = rtcninja.attachMediaStream(peerBremoteVideo, stream);
			};

			peerA.call(
				// success
				function(offer) {
					peerB.answer(offer,
						// success
						function(answer) {
							peerA.connection.setRemoteDescription(answer);
							onConnected();
							peerB.connection.oniceconnectionstatechange = function(event, state) {
								if (state === 'connected' || state === 'completed') {
									onEstablished();
								}
							}
						},
						// failure
						function(error) {
							debugerror('PeerB.answer() failed: ', error);
							onStopped();
							throw error;
						}
					);
				},
				// failure
				function(error) {
					debugerror('PeerA.call() failed: ', error);
					onStopped();
					throw error;
				}
			);
		}

		function stop() {
			debug('stop()');

			onStopped();

			if (peerA) {
				peerA.connection.close();
				peerB.connection.close();
			}
			// if (localStream) {
			// 	rtcninja.closeMediaStream(localStream);
			// 	localStream = null;
			// }

			// TODO: This does not work with the Temasys plugin.
			peerAlocalVideo.src = '';
			peerAremoteVideo.src = '';
			peerBlocalVideo.src = '';
			peerBremoteVideo.src = '';
		}
	}
	</script>
</head>

<body>

	<div class='header'></div>

	<div class='videos'>
		<div id='peerA' class='peerVideo'>
			<p class='remote'>peer B</p>
			<p class='local'>peer A</p>
			<video class='remote' autoplay></video>
			<video class='local' autoplay muted='true'></video>
		</div>

		<div class='space'></div>

		<div id='peerB' class='peerVideo'>
			<p class='remote'>peer A</p>
			<p class='local'>peer B</p>
			<video class='remote' autoplay></video>
			<video class='local' autoplay muted='true'></video>
		</div>
	</div>

	<div id='startStopButton'>start</div>
</body>

</html>
