<!DOCTYPE html>
<html>

<head>
	<title>rtcninja.js</title>
	<meta http-equiv='Content-Type' content='text/html; charset=utf-8' />
	<script src='Temasys-adapter.js'></script>
	<script src='rtcninja.js'></script>
	<script>
		// rtcninja.debug.enable('rtcninja*');
		rtcninja.debug.enable('*');
	</script>

	<script>
	function test() {
		var debug = rtcninja.debug('index.html');
		var conn = null;
		var localStream = null;

		rtcninja.getUserMedia(
			{audio:true, video:true},
			onGetUserMediaSucess,
			onGetUserMediaFailure
		);

		function closeAll() {
			if (conn) {
				conn.close();
			}
			if (localStream) {
				rtcninja.Utils.closeMediaStream(localStream);
			}
		}

		function onGetUserMediaSucess(stream) {
			debug('onGetUserMediaSucess()');

			var pcConfig = {
				iceServers: [{
					urls: [
						'turn:turn.ef2f.com:3478?transport=udp',
						'turn:turn.ef2f.com:3478?transport=tcp',
						'turns:turn.ef2f.com:443?transport=tcp'
					],
					username: 'turn',
					credential: 'ef2f'
				}],
				_iceTransports: 'relay',
				gatheringTimeoutAfterRelay: 500
			};

			conn = new rtcninja.Connection(pcConfig);
			window.conn = conn;

			conn.on('icecandidate', function(candidate) {
				debug('event icecandidate: %o', candidate);

				if (! candidate) {
					debug('final localDescription: %o', conn.localDescription);
					closeAll();
				}
			});

			conn.on('signalingstatechange', function(state) {
				debug('event signalingstatechange: %s', state);
			});

			conn.on('addstream', function(stream) {
				debug('event addstream: %s', stream);
			});

			conn.on('removestream', function(stream) {
				debug('event removestream: %s', stream);
			});

			conn.on('iceconnectionstatechange', function(state) {
				debug('event iceconnectionstatechange: %s', state);
			});

			conn.on('icegatheringstatechange', function(state) {
				debug('event icegatheringstatechange: %s', state);
			});

			conn.on('datachannel', function(channel) {
				debug('event datachannel: %o', channel);
			});

			var options = {
				offerToReceiveAudio: 1,
				offerToReceiveVideo: 1
			};

			localStream = stream;
			window.localStream = stream;
			conn.addStream(stream);
			createOffer(onCreateOfferSuccess, onCreateOfferFailure, options)
		}

		function onGetUserMediaFailure(error) {
			console.error('onGetUserMediaFailure():', error);
		}

		function createOffer() {
			debug('createOffer()');

			var options = {
				offerToReceiveAudio: 1,
				offerToReceiveVideo: 1
			};

			conn.createOffer(onCreateOfferSuccess, onCreateOfferFailure, options);
		}

		function onCreateOfferSuccess(offer) {
			debug('onCreateOfferSuccess()');

			setLocalDescription(offer);
		}

		function onCreateOfferFailure(error) {
			console.error('onCreateOfferFailure():', error);
		}

		function setLocalDescription(offer) {
			debug('setLocalDescription()');

			conn.setLocalDescription(offer, onSetLocalDescriptionSuccess, onSetLocalDescriptionFailure);
		}

		function onSetLocalDescriptionSuccess() {
			debug('onSetLocalDescriptionSuccess() | localDescription: %o', conn.localDescription);
		}

		function onSetLocalDescriptionFailure(error) {
			console.error('onSetLocalDescriptionFailure():', error);
		}
	}
	</script>
</head>

<body onload='test()'></body>

</html>
